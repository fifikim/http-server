name: build-deploy

on:
  push:
    branches: [test-cd]

jobs:
  deploy-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Build with Gradle wrapper
        run: ./gradlew build

      - name: Upload new artifact to production server
        uses: mdallasanta/ssh-scp-deploy@v1.2.0
        with:
          local: 'build/libs/http-server.jar'
          remote: '~/test'
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          pre_upload: lsof -i:5000 -t | xargs -r kill

      - name: Start server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: java -jar test/http-server.jar